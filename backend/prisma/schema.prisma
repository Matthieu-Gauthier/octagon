generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id // Supabase UUID
  email     String   @unique
  username  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leagues      LeagueMember[]
  leaguesOwned League[]
  bets         Bet[]
  survivorPicks SurvivorPick[]

  @@map("users")
}

model League {
  id              String   @id @default(uuid())
  name            String
  code            String   @unique // 6-char invite code
  survivorEnabled Boolean  @default(false)
  isArchived      Boolean  @default(false)
  createdAt       DateTime @default(now())
  adminId         String
  admin           User     @relation(fields: [adminId], references: [id])
  
  members         LeagueMember[]
  bets            Bet[]
  survivorPicks   SurvivorPick[]
  
  scoringSettings Json     @default("{\"winner\": 10, \"method\": 5, \"round\": 5}") 

  @@map("leagues")
}

model LeagueMember {
  id        String   @id @default(uuid())
  leagueId  String
  userId    String
  role      String   @default("MEMBER") // MEMBER, ADMIN
  joinedAt  DateTime @default(now())

  league    League   @relation(fields: [leagueId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([leagueId, userId])
  @@map("league_members")
}

model Event {
  id              String    @id
  name            String
  date            DateTime
  location        String
  status          String            // SCHEDULED, LIVE, FINISHED
  prelimsStartAt  DateTime?         // scraped from #prelims-card data-timestamp
  mainCardStartAt DateTime?         // scraped from #main-card data-timestamp
  eventImg        String?           // scraped from c-hero__image src

  fights    Fight[]

  @@map("events")
}


model Fighter {
  id        String   @id // slug like 'jon-jones'
  name      String
  wins        Int?
  losses      Int?
  draws       Int?
  noContests  Int?
  winsByKo    Int?
  winsBySub   Int?
  winsByDec   Int?
  height      String?
  weight      String?
  reach       String?
  stance      String?
  sigStrikesLandedPerMin Float?
  takedownAvg Float?
  imagePath String?  // Local asset path
  hometown  String?  // scraped from bio section for flag mapping
  
  fightsA   Fight[]  @relation("FighterA")
  fightsB   Fight[]  @relation("FighterB")

  @@map("fighters")
}

model Fight {
  id          String   @id // slug 'fb-main'
  eventId     String
  fighterAId  String
  fighterBId  String
  division    String
  rounds      Int
  isMainEvent Boolean  @default(false)
  isCoMainEvent Boolean @default(false)
  isMainCard  Boolean  @default(true)
  isPrelim    Boolean  @default(false)
  status      String   @default("SCHEDULED") // SCHEDULED, LIVE, FINISHED
  
  // Result
  winnerId    String?
  method      String?  // KO/TKO, SUBMISSION, DECISION, DRAW, NC
  round       Int?
  time        String?

  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  fighterA    Fighter  @relation("FighterA", fields: [fighterAId], references: [id])
  fighterB    Fighter  @relation("FighterB", fields: [fighterBId], references: [id])
  
  bets        Bet[]
  survivorPicks SurvivorPick[]

  @@map("fights")
}

model Bet {
  id        String   @id @default(uuid())
  leagueId  String
  userId    String
  fightId   String
  
  winnerId  String
  method    String?
  round     Int?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  league    League   @relation(fields: [leagueId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  fight     Fight    @relation(fields: [fightId], references: [id], onDelete: Cascade)

  @@unique([leagueId, userId, fightId])
  @@map("bets")
}

model SurvivorPick {
  id        String   @id @default(uuid())
  leagueId  String
  userId    String
  fightId   String
  eventId   String // Denormalized for easy queries per event
  
  fighterId String // Who they picked to win
  status    String @default("PENDING") // PENDING, WON, LOST, DRAW, NC
  
  createdAt DateTime @default(now())

  league    League   @relation(fields: [leagueId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  fight     Fight    @relation(fields: [fightId], references: [id], onDelete: Cascade)

  @@unique([leagueId, userId, fightId])
  @@map("survivor_picks")
}
