# Implementation Plan: Lock Bets by Card-Section Start Timestamp

**Branch**: `006-lock-bets-timestamp` | **Date**: 2026-02-21 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `specs/006-lock-bets-timestamp/spec.md`

## Summary

Scrape `data-timestamp` from the UFC event page's `#main-card` and `#prelims-card` divs, store them as `mainCardStartAt` / `prelimsStartAt` on the `Event` model, and use those values as the per-section bet cutoff instead of the single `event.date`. Additionally, display a deadline indicator on each `VegasFightCard` component showing when bets will lock.

See [research.md](./research.md), [data-model.md](./data-model.md), [contracts/api.md](./contracts/api.md), [quickstart.md](./quickstart.md).

## Technical Context

**Language/Version**: TypeScript (Node 20 backend, Vite React frontend)  
**Primary Dependencies**: NestJS, Prisma, Cheerio (backend); React, Tailwind CSS, Zustand (frontend)  
**Storage**: PostgreSQL (Prisma ORM)  
**Testing**: Jest (backend unit tests)  
**Target Platform**: Linux server (Docker), Web browser  
**Project Type**: Web application (backend/ + frontend/)  
**Performance Goals**: No change — existing scraper frequency is sufficient  
**Constraints**: Backward compatible; nullable fields, fallback to `event.date`  
**Scale/Scope**: Single event at a time; ~10–30 fights per scrape

## Constitution Check

| Principle | Status | Notes |
|-----------|--------|-------|
| League-Centric Architecture | ✅ Pass | Bets remain keyed by `leagueId`; no global state introduced |
| Backend Architecture (NestJS + Prisma) | ✅ Pass | All backend changes within existing NestJS modules |
| Mandatory Unit Testing (Jest) | ✅ Pass | New tests added to `bets.service.spec.ts` and `scraper.service.spec.ts` |
| Frontend Standards (React+Vite+Tailwind) | ✅ Pass | UI change in existing `FightCard.tsx`, no new dependencies |
| Gameplay Mechanics (bets locked after fight start) | ✅ Pass | This feature refines the existing lock mechanic — per-section instead of single cutoff |
| Iterative Workflow (Spec-Kit) | ✅ Pass | Spec, clarify, plan all completed before implementation |

*No violations — Complexity Tracking table not needed.*

## Project Structure

### Documentation (this feature)

```text
specs/006-lock-bets-timestamp/
├── plan.md              ← this file
├── spec.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── api.md
└── checklists/
    └── requirements.md
```

### Source Code Changes (repository root)

```text
backend/
├── prisma/
│   └── schema.prisma                        ← MODIFY: add prelimsStartAt, mainCardStartAt
├── prisma/migrations/
│   └── <timestamp>_add_card_section_timestamps/  ← NEW (generated by prisma migrate)
└── src/
    ├── events/
    │   ├── scraper.service.ts               ← MODIFY: ScrapedEvent interface + extraction logic
    │   ├── scraper.service.spec.ts          ← MODIFY: add timestamp extraction tests
    │   └── events.service.ts               ← MODIFY: upsert includes new fields
    └── bets/
        ├── bets.service.ts                  ← MODIFY: per-section cutoff logic
        └── bets.service.spec.ts             ← MODIFY: add per-section lock tests

frontend/
└── src/
    ├── types/
    │   └── api.ts                           ← MODIFY: Event interface + new fields
    └── components/
        └── FightCard.tsx                    ← MODIFY: lockAt prop + deadline indicator UI
```

**Structure Decision**: Option 2 (Web application) — existing backend/ + frontend/ layout.

## Proposed Implementation

### 1 · Prisma Schema + Migration

**File**: `backend/prisma/schema.prisma`  
Add to `model Event`:
```prisma
prelimsStartAt  DateTime?
mainCardStartAt DateTime?
```
Run: `npx prisma migrate dev --name add-card-section-timestamps && npx prisma generate`

---

### 2 · ScraperService — Extract Timestamps

**File**: `backend/src/events/scraper.service.ts`

- Extend `ScrapedEvent` interface with `prelimsStartAt?: Date; mainCardStartAt?: Date;`
- Add private helper `extractSectionTimestamp($, sectionId)` that finds `.c-event-fight-card-broadcaster__time` within the given section and reads `data-timestamp`
- Call it for `#prelims-card` and `#main-card` after the existing HTML parse
- Include results on the returned event object

---

### 3 · EventsService — Persist New Fields

**File**: `backend/src/events/events.service.ts`

- In `fetchNextEvent()`, add `prelimsStartAt` and `mainCardStartAt` to the event upsert `update` and `create` payloads

---

### 4 · BetsService — Per-Section Cutoff

**File**: `backend/src/bets/bets.service.ts`

- Include `prelimsStartAt`, `mainCardStartAt` in the `findUnique` event include
- Replace single `now >= fight.event.date` check with:
  ```typescript
  const cutoff = fight.isPrelim
    ? (fight.event.prelimsStartAt ?? fight.event.date)
    : (fight.event.mainCardStartAt ?? fight.event.date);
  if (now >= cutoff) {
    const section = fight.isPrelim ? 'preliminary card' : 'main card';
    throw new BadRequestException(`Betting is closed for ${section} fights`);
  }
  ```

---

### 5 · Frontend Types

**File**: `frontend/src/types/api.ts`  
Add to `Event` interface:
```typescript
prelimsStartAt?: string | null;
mainCardStartAt?: string | null;
```

---

### 6 · FightCard — Deadline Indicator UI

**File**: `frontend/src/components/FightCard.tsx`

- Add `lockAt?: string | null` to `VegasFightCardProps`
- Compute `const isLocked = locked || (!!lockAt && new Date() >= new Date(lockAt));`
- Render a thin banner below the event-type header with lock time or "Bets locked" state
- Use the existing `Lock` icon (already imported) + Tailwind classes consistent with the dark theme

**Parent components** pass `lockAt` derived from `event.prelimsStartAt` (if `fight.isPrelim`) or `event.mainCardStartAt` (otherwise).

## Verification Plan

### Automated Tests (Jest)

Run all backend unit tests:
```bash
cd backend && npm run test
```

Run specific test files:
```bash
cd backend && npm run test -- --testPathPattern="bets.service.spec|scraper.service.spec"
```

**New test cases to add in `bets.service.spec.ts`**:

| Scenario | Expected |
|----------|----------|
| Prelim fight, `now < prelimsStartAt` | Bet accepted |
| Prelim fight, `now >= prelimsStartAt` | `BadRequestException` with message containing "preliminary card" |
| Main card fight, `now < mainCardStartAt` | Bet accepted |
| Main card fight, `now >= mainCardStartAt` | `BadRequestException` with message containing "main card" |
| Prelim fight, `prelimsStartAt` is null, `now < event.date` | Bet accepted (fallback) |
| Prelim fight, `prelimsStartAt` is null, `now >= event.date` | `BadRequestException` (fallback) |
| Fight status = FINISHED | `BadRequestException` (unchanged) |

**New test cases to add in `scraper.service.spec.ts`**:

| Scenario | Expected |
|----------|----------|
| HTML contains both `#main-card` and `#prelims-card` timestamp elements | `mainCardStartAt` and `prelimsStartAt` are valid Dates |
| HTML contains only `#main-card` timestamp | `mainCardStartAt` set, `prelimsStartAt` undefined |
| HTML contains neither timestamp | Both fields undefined |

### Manual Verification

1. **Trigger a scrape**: Call `POST /admin/events/fetch` (requires admin token). Confirm response includes non-null `prelimsStartAt` and `mainCardStartAt` on the event object.
2. **Check DB**: Verify `events` table has both new columns populated for the scraped event.
3. **UI deadline indicator**: Open the event page in the browser. Confirm each fight card shows "Bets lock: [date/time]" below the event-type header (Main Event / Co-Main / standard).
4. **UI locked state**: Temporarily set `prelimsStartAt` to a past time in the DB and reload → prelim fight cards should show "Bets locked" state with bet actions disabled.
